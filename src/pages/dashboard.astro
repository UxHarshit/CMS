---
import Layout from "@/layouts/Layout.astro";
import "../global.css";
import DashboardPage from "@/components/Dashboard/page.tsx";
import jwt from "jsonwebtoken";
import { Debug } from "astro:components";

const baseUrl = import.meta.env.REACT_APP_BASE_URL;

// Get the token
const token = Astro.cookies.get("token");
var decoded_token = null;
if (!token) {
  return Astro.redirect("/login");
} else {
  try {
    const decoded = jwt.verify(
      token.value,
      "7feb11e09142b4a8170f3c7570377d4fa35f2dcf031434fcd9f018e84c70450eaf63525dc803be4634f8b1d9a9cb66a51ba67e4024deec583a4586ae0e060ce5"
    );
    if (
      typeof decoded !== "string" &&
      decoded.exp &&
      decoded.exp < Date.now() / 1000
    ) {
      Astro.cookies.delete("token");
      return Astro.redirect("/login");
    } else {
      decoded_token = decoded;
    }
  } catch (error) {
    Astro.cookies.delete("token");
    return Astro.redirect("/login");
  }
}
var out = null;
var status = false;
var code = null;
if (decoded_token) {
  out = await fetch(`${baseUrl}/api/users/dashboard`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token.value}`,
    },
  })
    .then(async (response) => {
      var data = await response.json();
      code = data["code"];
      status = true;

      if (response.status === 401) {
        Astro.cookies.delete("token");
        status = false;
      }
      if (response.status === 403) {
        status = false;
      }
      if (response.status === 500) {
        status = false;
      }
      if(!response.ok) status = false;
      return {
        props: { status: status, data, code: data["code"] },
      };
    })
    .catch((error) => {
      return new Response("Error: " + error);
    });

  if (status === false) {
    if(code === "BAN"){
      return Astro.redirect("/banned");
    } else if (code === "VERIFY") {
      return Astro.redirect("/verify");
    } else {
      Astro.cookies.delete("token");
      return Astro.redirect("/login");
    }
  }

  if (out instanceof Response) {
    Astro.cookies.delete("token");
    return Astro.redirect("/login");
  }
}
---


<Layout title="Dashboard">
  <DashboardPage transition:persist  client:load {...out as any} baseUrl={baseUrl} />
</Layout>
