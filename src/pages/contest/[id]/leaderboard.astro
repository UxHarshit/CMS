---
import Layout from "../../../layouts/Layout.astro";
import "../../../global.css";
import LeaderBoardPage from "@/components/Contest/Leaderboard/page.tsx";
import jwt from "jsonwebtoken";
import { Debug } from "astro:components";

const baseUrl = import.meta.env.REACT_APP_BASE_URL;

const id = Astro.params.id;

if (!id) {
  return Astro.redirect("/dashboard");
}

const token = Astro.cookies.get("token");
var decoded_token = null;
if (!token) {
  return Astro.redirect("/login");
} else {
  try {
    const decoded = jwt.verify(
      token.value,
      "7feb11e09142b4a8170f3c7570377d4fa35f2dcf031434fcd9f018e84c70450eaf63525dc803be4634f8b1d9a9cb66a51ba67e4024deec583a4586ae0e060ce5"
    );
    if (
      typeof decoded !== "string" &&
      decoded.exp &&
      decoded.exp < Date.now() / 1000
    ) {
      Astro.cookies.delete("token");
      return Astro.redirect("/login");
    } else {
      decoded_token = decoded;
    }
  } catch (error) {
    Astro.cookies.delete("token");
    return Astro.redirect("/login");
  }
}
var all_ok = false;

var out = await fetch(`${baseUrl}/api/contest/getDetails`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer ${token.value}`,
  },
  body: JSON.stringify({ contestId: id }),
})
  .then(async (response) => {
    if (response.ok) {
      all_ok = true;
      return {props: await response.json() };
    } else {
      all_ok = false;
      return { data: "Failed" };
    }
  })
  .catch((error) => {
    all_ok = false;
    return { data: "Failed" };
  });

if (!all_ok) {
  return Astro.redirect("/dashboard");
}
---

<Layout title="Leaderboard">
  <LeaderBoardPage {...out as any} id={id} baseUrl={baseUrl} client:load />
</Layout>
