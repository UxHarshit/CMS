---
import Layout from "../../layouts/Layout.astro";
import "../../global.css";
import EditProblemPage from "@/components/Admin/editProblem.tsx";
import jwt from "jsonwebtoken";
import { Debug } from "astro:components";

const id = Astro.url.searchParams.get("id");

if (!id) {
  return Astro.redirect("/admin/manageProblems");
}

const token = Astro.cookies.get("token");
var decoded_token = null;
if (!token) {
  return Astro.redirect("/login");
} else {
  try {
    const decoded = jwt.verify(
      token.value,
      "7feb11e09142b4a8170f3c7570377d4fa35f2dcf031434fcd9f018e84c70450eaf63525dc803be4634f8b1d9a9cb66a51ba67e4024deec583a4586ae0e060ce5"
    );
    if (
      typeof decoded !== "string" &&
      decoded.exp &&
      decoded.exp < Date.now() / 1000
    ) {
      Astro.cookies.delete("token");
      return Astro.redirect("/login");
    } else {
      decoded_token = decoded;
    }
  } catch (error) {
    Astro.cookies.delete("token");
    return Astro.redirect("/login");
  }
}
var out = null;
if (decoded_token) {
  out = await fetch("http://localhost:5000/api/users/basicUserInfo", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token.value}`,
    },
  })
    .then((response) => {
      if (response.ok) {
        return response.json();
      } else {
        return new Response("Error: " + response.statusText);
      }
    })
    .then(async (data) => {
      const problem = await fetch(`http://localhost:5000/api/problems/${id}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token.value}`,
        },
      });

      const { question, testCases } = await problem.json();

      return {
        props: { 
            data,
            id,
            question,
            testCases
         },
      };
    })
    .catch((error) => {
      return new Response("Error: " + error);
    });

  if (out instanceof Response) {
    return Astro.redirect("/login");
  }

  if (out.props.data.isAdmin === false) {
    return Astro.redirect("/login");
  }
}

const baseUrl = import.meta.env.REACT_APP_BASE_URL;
---

<Layout>
  <EditProblemPage client:load {...out as any} baseUrl={baseUrl} />
</Layout>
