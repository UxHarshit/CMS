---
import Layout from "../../../layouts/Layout.astro";
import "../../../global.css";
import EditContestPage from "@/components/Admin/editContest.tsx";
import jwt from "jsonwebtoken";
const baseUrl = import.meta.env.REACT_APP_BASE_URL;


const token = Astro.cookies.get("token");
var decoded_token = null;
if (!token) {
  return Astro.redirect("/login");
} else {
  try {
    const decoded = jwt.verify(
      token.value,
      "7feb11e09142b4a8170f3c7570377d4fa35f2dcf031434fcd9f018e84c70450eaf63525dc803be4634f8b1d9a9cb66a51ba67e4024deec583a4586ae0e060ce5"
    );
    if (
      typeof decoded !== "string" &&
      decoded.exp &&
      decoded.exp < Date.now() / 1000
    ) {
      Astro.cookies.delete("token");
      return Astro.redirect("/login");
    } else {
      decoded_token = decoded;
    }
  } catch (error) {
    Astro.cookies.delete("token");
    return Astro.redirect("/login");
  }
}
var out = null;
if (decoded_token) {
  out = await fetch(`${baseUrl}/api/users/basicUserInfo`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token.value}`,
    },
  })
    .then((response) => {
      if (response.ok) {
        return response.json();
      } else {
        return new Response("Error: " + response.statusText);
      }
    })
    .then(async(data) => {
        const contestData = await fetch(`${baseUrl}/api/admin/getContestData`,{
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token.value}`,
            },
            body: JSON.stringify({
                contestId: Astro.params.id,
            }),
            }).then((response) => {
            if (response.ok) {
                return response.json();
            } else {
                return new Response("Error: " + response.statusText);
            }
            }).catch((error) => {
            return new Response("Error: " + error);
        })

      return {
        props: { data , contestData},
      };
    })
    .catch((error) => {
      return new Response("Error: " + error);
    });

  if (out instanceof Response) {
    return Astro.redirect("/login");
  }

  if (out.props.data.isAdmin === false) {
    return Astro.redirect("/login");
  }
}
---

<Layout title="Edit Contest">
  <EditContestPage client:load {...out as any} baseUrl={baseUrl} />
</Layout>